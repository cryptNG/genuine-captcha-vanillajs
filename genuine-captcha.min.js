export default class GenuineCaptcha extends HTMLElement{captchaSecret=null;timerId=null;name='';gcApiUrl=`https://api.genuine-captcha.io`;handleVerify=(a,b,c)=>{};handleReset=a=>{};_handleVerify=(a,A)=>{this.name!==''?this.handleVerify(this.name,a,A):this.handleVerify(a,A)};_handleReset=()=>{this.name!==''?this.handleReset(this.name):this.handleReset()};constructor(){super();this.abortController=new AbortController;this.texts={};navigator.language.toLowerCase().indexOf('de')===0&&(this.texts={puzzleTitle:'Kleines Rätsel: Was ist die Lösung?',inputPlaceholder:'Deine Antwort',verifyButton:'Überprüfen',verifying:'Prüfend...',refreshButton:'Neues CAPTCHA',loadingCaptcha:'Lade CAPTCHA...',errorLoadingCaptcha:'Fehler beim Laden des CAPTCHAs. Bitte versuche es erneut.',errorIncorrectSolution:'Falsche Lösung. Bitte versuche es erneut.',errorFailedToVerify:'Fehler bei der Überprüfung. Bitte versuche es erneut.',successMessage:'Erfolg! CAPTCHA korrekt gelöst.',alertNoSolution:'Bitte gib deine Antwort zum CAPTCHA ein',responseOk:'<strong>Erfolg!</strong> CAPTCHA korrekt gelöst.',responseNotOk:'<strong>Fehler:</strong> Falsche Lösung. Bitte versuche es erneut.',responseFailedToVerify:'<strong>Fehler:</strong> Fehler bei der Überprüfung. Bitte versuche es erneut.'});(navigator.language.toLowerCase().indexOf('en')===0||this.texts.puzzleTitle===void 0)&&(this.texts={puzzleTitle:'Tiny puzzle time: what is the solution?',inputPlaceholder:'Your answer',verifyButton:'Verify',verifying:'Verifying...',refreshButton:'Try Another CAPTCHA',loadingCaptcha:'Loading CAPTCHA...',errorLoadingCaptcha:'Error loading CAPTCHA. Please try again.',errorIncorrectSolution:'Incorrect solution. Please try again.',errorFailedToVerify:'Failed to verify. Please try again.',successMessage:'Success! CAPTCHA verified correctly.',alertNoSolution:'Please enter your answer to the CAPTCHA',responseOk:'<strong>Success!</strong> CAPTCHA verified correctly.',responseNotOk:'<strong>Error:</strong> Incorrect solution. Please try again.',responseFailedToVerify:'<strong>Error:</strong> Failed to verify. Please try again.'});this.captchaSecret='';let _=document.getElementById('genuine-captcha'),B=_.content,d=document.createElement('style');this.attachShadow({mode:'open'});let C=this.shadowRoot;d.textContent=`
          :host{
            --verify-button-background-color:#6366f1;
            --verify-button-background-color-hover:#4346d4;
            --text-color-light: rgba(209, 209, 209, 1);
            --text-color-dark: #212121;
            --text-color: light-dark( var(--text-color-dark),var(--text-color-light));
            --font-size: larger;
          }

          .captcha-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width:100%;
            position:relative;
            overflow: hidden;
            color: var(--text-color);
            font-size: var(--font-size);
        }
          #captcha-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            position: relative;
            opacity:0;
            transition:all 0.2s ease-in-out;
        }

        #captcha-display.show{
          opacity:1;
        }
        
        #captcha-image-container {
            position: relative;
            
            overflow: hidden;
            width: 200px;
            height: calc(150px + 2rem);
            display: flex;
          flex-direction: column;
          align-items: flex-end;
          justify-content: center;
        }
        
        #captcha-image {
            max-width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }
        
        #captcha-loading {

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            position: absolute;
            background: white;
            width: 100%;
            border-radius: 0.5rem;
            opacity: 0;
            
            transition:all 0.2s ease-in-out;
        }
        #captcha-loading.show{
          opacity:0.9;
          top:0;
        }

        #captcha-loading:not(.show){
          animation:moveOut 0.3s linear forwards;
        }
        
        @keyframes moveOut {
          0% { top:0; }
          99% { top:0; }
          100% { top:-100%; }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #6366f1;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        #allowed-action{
          display: flex;
          flex-direction: column;
          align-items: center;
          position:absolute;
          opacity:0;
          transition:all 0.2s ease-in-out;
          height:100%;
          justify-content: center;
        }

        #allowed-action.show{
          opacity:1;
        }

        #allowed-action:not(.show){
          animation:moveOut 0.3s linear forwards;
        }

        #refresh-captcha{
          background-color: transparent;
          border: none;
          text-decoration: underline;
          font-size: small;
          color: light-dark( var(--form-primary), var(--form-primary-light, #3273ffff));
          cursor:pointer;

        }
        
        #verify-captcha {
            padding: 8px 16px;
            border-radius: 6px;
        }

        #verify-captcha:not(:disabled) {
            background-color: var(--verify-button-background-color);
            color: white;
            border: 2px solid var(--verify-button-background-color);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #verify-captcha:disabled,#verify-captcha.disabled {
          cursor:not-allowed;
        }
        
        #verify-captcha:not(:disabled):hover {
            background-color: var(--verify-button-background-color-hover);
        }
        
        #captcha-error {
            padding: 15px;
            border-radius: 6px;
            display: none;
            margin-top: 15px;
       
        }

        #captcha-error.error {
           display: block;
        }

        .captcha-result {
            padding: 15px;
            border-radius: 6px;
            display: none;
            margin-bottom: 15px;
         
        }
        
        .success {
            background-color: light-dark(rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2));
            color: #10b981;
            padding: 15px;
            border-radius: 6px;
            display: block;
            margin-bottom: 15px;
           
        }
        
        .error {
            background-color: light-dark(rgba(239, 68, 68, 0.1),rgba(239, 68, 68, 0.2));
            color: #ef4444;
        }
      `;C.appendChild(d);C.appendChild(B.cloneNode(!0));C.querySelector('#captcha-solution').setAttribute('aria-label',this.texts.inputPlaceholder);C.querySelector('#verify-captcha').setAttribute('aria-label',this.texts.verifyButton);let e=document.createElement('div');e.setAttribute('role','status');e.setAttribute('aria-live','polite');e.style.position='absolute';e.style.left='-10000px';e.id='sr-announcements';C.appendChild(e);C.querySelector('.captcha-container #puzzle-title').innerText=this.texts.puzzleTitle;C.querySelector('.captcha-container #captcha-solution').placeholder=this.texts.inputPlaceholder;C.querySelector('.captcha-container #verify-captcha').innerText=this.texts.verifyButton;C.querySelector('.captcha-container #refresh-captcha .refresh-captcha-text').innerText=this.texts.refreshButton;C.querySelector('.captcha-container #loading-catcha').innerText=this.texts.loadingCaptcha;C.querySelector('.captcha-container #captcha-solution').addEventListener('keyup',_a=>{let _b=_a.target;_b.checkValidity()?C.querySelector('.captcha-container #verify-captcha').disabled=!1:C.querySelector('.captcha-container #verify-captcha').disabled=!0});this.registerHandleVerify();this.registerHandleReset();this.refreshHandler=D=>{D.stopPropagation();this._handleReset();this.loadCaptcha()};this.verifyHandler=_A=>{_A.stopPropagation();this.verifyCaptcha()};this.shadowRoot.querySelector('#refresh-captcha').addEventListener('click',this.refreshHandler);this.shadowRoot.querySelector('#verify-captcha').addEventListener('click',this.verifyHandler);(async ()=>{await b(100);this.loadCaptcha()})()}registerHandleVerify=async ()=>{let E=0,_B=150;while(window.genuineCaptchaHandleVerify===void 0&&E<_B){E++;await b(100)}window.genuineCaptchaHandleVerify?this.handleVerify=window.genuineCaptchaHandleVerify:console.warn('genuineCaptchaHandleVerify hook not found, using default')};registerHandleReset=async ()=>{while(window.genuineCaptchaReset===void 0)await b(100);this.handleReset=window.genuineCaptchaReset};static get observedAttributes(){return['api-url','api-key','name']}attributeChangedCallback(aA,aB,_c){aA==='api-url'&&(this.gcApiUrl=_c);aA==='name'&&(this.name=_c)}startTimer=aC=>{clearTimeout(this.timerId);this.timerId=setTimeout(()=>this.loadCaptcha(),aC)};disconnectedCallback(){this.timerId&&(clearTimeout(this.timerId),this.timerId=null);this.abortController?.abort();this.refreshHandler&&this.shadowRoot.querySelector('#refresh-captcha')?.removeEventListener('click',this.refreshHandler);this.verifyHandler&&this.shadowRoot.querySelector('#verify-captcha')?.removeEventListener('click',this.verifyHandler)}loadCaptcha(){this.abortController?.abort();this.abortController=new AbortController;if(this.isLoading){console.log('Captcha already loading');return}this.isLoading=!0;this.timerId&&(clearTimeout(this.timerId),this.timerId=null);try{this.shadowRoot.getElementById('captcha-display').classList.add('show');this.shadowRoot.getElementById('captcha-loading').classList.add('show');this.shadowRoot.getElementById('captcha-error').classList.remove('error');this.shadowRoot.getElementById('allowed-action').classList.remove('show');this.shadowRoot.querySelector('.captcha-result').classList.remove('success');this.shadowRoot.getElementById('captcha-solution').value=''}catch(aD){console.error(aD);this.isLoading=!1;return}fetch(`${this.gcApiUrl}/api/captcha/create`,{mode:'cors',signal:this.abortController.signal}).then(aE=>aE.json()).then(aF=>{if(!aF||!aF.ImageAsBase64||!aF.SecretAsBase64){console.error('Invalid captcha response format');return}let aG='image/png';this.shadowRoot.getElementById('captcha-image').src=`data:${aG};base64,${aF.ImageAsBase64}`;this.captchaSecret=aF.SecretAsBase64;let _C=(aF.validTill||Date.now()+(1000*60*5))-2000;this.startTimer(_C-Date.now());this.shadowRoot.getElementById('captcha-loading').classList.remove('show')}).catch(aH=>{if(aH.name==='AbortError'){console.log('Captcha load aborted');return}console.error('Error loading captcha:',aH);this.shadowRoot.getElementById('captcha-loading').innerHTML=this.texts.errorLoadingCaptcha}).finally(()=>this.isLoading=!1)}verifyCaptcha(){if(this.isVerifying)return;let aI=this.shadowRoot.getElementById('captcha-solution').value.trim(),aK=this.shadowRoot.getElementById('verify-captcha'),_d=aK.textContent;if(!aI){let aL=this.shadowRoot.getElementById('captcha-error');aL.classList.add('error');aL.textContent=this.texts.alertNoSolution;let aM=this.shadowRoot.getElementById('sr-announcements');aM.textContent=this.texts.alertNoSolution;this.shadowRoot.getElementById('captcha-solution').focus();return}let aJ=aI.replace(/[^\w\s-]/g,'');if(aJ.length>3)return;this.isVerifying=!0;aK.disabled=!0;aK.textContent=this.texts.verifying;fetch(`${this.gcApiUrl}/api/captcha/verify?captchaSolution=${aJ}&captchaSecret=${encodeURIComponent(this.captchaSecret)}`,{mode:'cors',signal:this.abortController.signal}).then(aN=>{if(aN.ok){this.shadowRoot.getElementById('captcha-display').classList.remove('show');this.shadowRoot.getElementById('allowed-action').classList.add('show');let aO=this.shadowRoot.querySelector('.captcha-result');aO.classList.add('success');aO.innerHTML=this.texts.responseOk;this.shadowRoot.getElementById('captcha-error').classList.remove('error');this._handleVerify(aI,this.captchaSecret)}else{let aP=this.shadowRoot.getElementById('captcha-error');aP.classList.add('error');aP.innerHTML=this.texts.responseNotOk}}).catch(aQ=>{if(aQ.name==='AbortError'){console.log('Captcha load aborted');return}console.error('Error verifying captcha:',aQ);let aR=this.shadowRoot.getElementById('captcha-error');aR.classList.add('error');aR.innerHTML=this.texts.responseFailedToVerify}).finally(()=>{this.isVerifying=aK.disabled=!1;aK.textContent=_d})}}function b(aS){return new Promise(aT=>setTimeout(aT,aS))}let c=`<div class="captcha-container">
        <div id="captcha-display" class="show">
            <div id="captcha-image-container">
                <img id="captcha-image" alt="CAPTCHA Challenge" src="" loading="lazy"/>
                <button id="refresh-captcha">&#10227; <span class="refresh-captcha-text"/></button>     
            </div>
            
            <div id="captcha-input-container">
                <p id="puzzle-title">Tiny puzzle time: what is the solution?</p>
                <div class="input-group">
                    <input type="text" id="captcha-solution" placeholder="" pattern="[0-9]{1,2}" required>
                    <button id="verify-captcha" disabled></button>
                </div>
            </div>
            
            <div id="captcha-error"></div>
            
            <div id="captcha-loading">
                <div class="spinner"></div>
                <p id="loading-catcha"></p>
            </div>
        </div>
        <div id="allowed-action">
            <div class="captcha-result"></div>
            <slot></slot>
        </div>
        
    </div>`;if(typeof document!=='undefined')if(customElements.get('genuine-captcha'))console.warn('genuine-captcha already defined');else{let aU=()=>{if(!document.getElementById('genuine-captcha')){let aV=document.createElement('template');aV.id='genuine-captcha';aV.innerHTML=c;document.body?document.body.prepend(aV):document.addEventListener('DOMContentLoaded',()=>document.body.prepend(aV))}};document.readyState==='loading'?document.addEventListener('DOMContentLoaded',aU):aU();customElements.define('genuine-captcha',GenuineCaptcha)}export{GenuineCaptcha};
